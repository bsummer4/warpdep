<!DOCTYPE html>
<html>
  <head>
    <title>wai/Network/Wai.hs</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../srcco.css">
    <script src="../../srcco.js"></script>
  </head>
  <body>
    <div class="tocs">
      <div id="files" class="toc-name">
        files
      </div>
      <div id="defs" class="toc-name">
        defs
      </div>
      <div id="files-toc" class="toc">
        <div class="node" level=0><div class="node-title"><i class="fa fa-angle-right carrot"></i> all files</div>
<div class="node-body"><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> auto-update</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Control</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> AutoUpdate</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../auto-update/Control/AutoUpdate/Util.hs.html">Util.hs</a></div></div></div><div class="node-path"><a class="file" href="../../auto-update/Control/AutoUpdate.hs.html">AutoUpdate.hs</a></div><div class="node-path"><a class="file" href="../../auto-update/Control/Debounce.hs.html">Debounce.hs</a></div><div class="node-path"><a class="file" href="../../auto-update/Control/Reaper.hs.html">Reaper.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> test</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Control</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../auto-update/test/Control/AutoUpdateSpec.hs.html">AutoUpdateSpec.hs</a></div><div class="node-path"><a class="file" href="../../../auto-update/test/Control/ReaperSpec.hs.html">ReaperSpec.hs</a></div></div></div><div class="node-path"><a class="file" href="../../auto-update/test/Spec.hs.html">Spec.hs</a></div></div></div><div class="node-path"><a class="file" href="../auto-update/Setup.hs.html">Setup.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> mime-types</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../mime-types/Network/Mime.hs.html">Mime.hs</a></div></div></div><div class="node-path"><a class="file" href="../mime-types/Setup.lhs.html">Setup.lhs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../wai/Network/Wai/Internal.hs.html">Internal.hs</a></div></div></div><div class="node-path"><a class="file" href="../../wai/Network/Wai.hs.html">Wai.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> test</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../wai/test/Network/WaiSpec.hs.html">WaiSpec.hs</a></div></div></div><div class="node-path"><a class="file" href="../../wai/test/Spec.hs.html">Spec.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> webkit-sample</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../wai/webkit-sample/webkit-sample.hs.html">webkit-sample.hs</a></div></div></div><div class="node-path"><a class="file" href="../wai/Setup.lhs.html">Setup.lhs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-app-static</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> WaiAppStatic</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Storage</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Embedded</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-app-static/WaiAppStatic/Storage/Embedded/Runtime.hs.html">Runtime.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-app-static/WaiAppStatic/Storage/Embedded/TH.hs.html">TH.hs</a></div></div></div><div class="node-path"><a class="file" href="../../../wai-app-static/WaiAppStatic/Storage/Embedded.hs.html">Embedded.hs</a></div><div class="node-path"><a class="file" href="../../../wai-app-static/WaiAppStatic/Storage/Filesystem.hs.html">Filesystem.hs</a></div></div></div><div class="node-path"><a class="file" href="../../wai-app-static/WaiAppStatic/CmdLine.hs.html">CmdLine.hs</a></div><div class="node-path"><a class="file" href="../../wai-app-static/WaiAppStatic/Listing.hs.html">Listing.hs</a></div><div class="node-path"><a class="file" href="../../wai-app-static/WaiAppStatic/Types.hs.html">Types.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> test</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../wai-app-static/test/EmbeddedTestEntries.hs.html">EmbeddedTestEntries.hs</a></div><div class="node-path"><a class="file" href="../../wai-app-static/test/WaiAppEmbeddedTest.hs.html">WaiAppEmbeddedTest.hs</a></div><div class="node-path"><a class="file" href="../../wai-app-static/test/WaiAppStaticTest.hs.html">WaiAppStaticTest.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Application</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-app-static/Network/Wai/Application/Static.hs.html">Static.hs</a></div></div></div></div></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> app</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../wai-app-static/app/warp-static.hs.html">warp-static.hs</a></div></div></div><div class="node-path"><a class="file" href="../wai-app-static/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../wai-app-static/Util.hs.html">Util.hs</a></div><div class="node-path"><a class="file" href="../wai-app-static/embedded-sample.hs.html">embedded-sample.hs</a></div><div class="node-path"><a class="file" href="../wai-app-static/sample.hs.html">sample.hs</a></div><div class="node-path"><a class="file" href="../wai-app-static/tests.hs.html">tests.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-conduit</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../wai-conduit/Network/Wai/Conduit.hs.html">Conduit.hs</a></div></div></div></div></div><div class="node-path"><a class="file" href="../wai-conduit/Setup.hs.html">Setup.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-extra</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Middleware</div>
<div class="node-body"><div class="node" level=5><div class="node-title"><i class="fa fa-angle-right carrot"></i> RequestLogger</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../../wai-extra/Network/Wai/Middleware/RequestLogger/Internal.hs.html">Internal.hs</a></div></div></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/AcceptOverride.hs.html">AcceptOverride.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/AddHeaders.hs.html">AddHeaders.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/Autohead.hs.html">Autohead.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/CleanPath.hs.html">CleanPath.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/Gzip.hs.html">Gzip.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/HttpAuth.hs.html">HttpAuth.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/Jsonp.hs.html">Jsonp.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/Local.hs.html">Local.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/MethodOverride.hs.html">MethodOverride.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/MethodOverridePost.hs.html">MethodOverridePost.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/RequestLogger.hs.html">RequestLogger.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/Rewrite.hs.html">Rewrite.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/StreamFile.hs.html">StreamFile.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Middleware/Vhost.hs.html">Vhost.hs</a></div></div></div><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Handler</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Handler/CGI.hs.html">CGI.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/Handler/SCGI.hs.html">SCGI.hs</a></div></div></div><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> EventSource</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-extra/Network/Wai/EventSource/EventStream.hs.html">EventStream.hs</a></div></div></div><div class="node-path"><a class="file" href="../../../wai-extra/Network/Wai/EventSource.hs.html">EventSource.hs</a></div><div class="node-path"><a class="file" href="../../../wai-extra/Network/Wai/Parse.hs.html">Parse.hs</a></div><div class="node-path"><a class="file" href="../../../wai-extra/Network/Wai/Test.hs.html">Test.hs</a></div><div class="node-path"><a class="file" href="../../../wai-extra/Network/Wai/UrlMap.hs.html">UrlMap.hs</a></div></div></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> app</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../wai-extra/app/Main.hs.html">Main.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> test</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-extra/test/Network/Wai/ParseSpec.hs.html">ParseSpec.hs</a></div><div class="node-path"><a class="file" href="../../../../wai-extra/test/Network/Wai/TestSpec.hs.html">TestSpec.hs</a></div></div></div></div></div><div class="node-path"><a class="file" href="../../wai-extra/test/Spec.hs.html">Spec.hs</a></div><div class="node-path"><a class="file" href="../../wai-extra/test/WaiExtraSpec.hs.html">WaiExtraSpec.hs</a></div><div class="node-path"><a class="file" href="../../wai-extra/test/sample.hs.html">sample.hs</a></div></div></div><div class="node-path"><a class="file" href="../wai-extra/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../wai-extra/proxy.hs.html">proxy.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-frontend-monadcgi</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Frontend</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-frontend-monadcgi/Network/Wai/Frontend/MonadCGI.hs.html">MonadCGI.hs</a></div></div></div></div></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> samples</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../wai-frontend-monadcgi/samples/plain_cgi.hs.html">plain_cgi.hs</a></div><div class="node-path"><a class="file" href="../../wai-frontend-monadcgi/samples/wai_cgi.hs.html">wai_cgi.hs</a></div><div class="node-path"><a class="file" href="../../wai-frontend-monadcgi/samples/wai_cgi_generic.hs.html">wai_cgi_generic.hs</a></div><div class="node-path"><a class="file" href="../../wai-frontend-monadcgi/samples/wai_fastcgi.hs.html">wai_fastcgi.hs</a></div></div></div><div class="node-path"><a class="file" href="../wai-frontend-monadcgi/Setup.lhs.html">Setup.lhs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-handler-fastcgi</div>
<div class="node-body"><div class="node-path"><a class="file" href="../wai-handler-fastcgi/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../wai-handler-fastcgi/test.hs.html">test.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-handler-launch</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Handler</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-handler-launch/Network/Wai/Handler/Launch.hs.html">Launch.hs</a></div></div></div></div></div></div></div><div class="node-path"><a class="file" href="../wai-handler-launch/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../wai-handler-launch/runtests.hs.html">runtests.hs</a></div><div class="node-path"><a class="file" href="../wai-handler-launch/test.hs.html">test.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-handler-webkit</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Handler</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-handler-webkit/Network/Wai/Handler/Webkit.hs.html">Webkit.hs</a></div></div></div></div></div></div></div><div class="node-path"><a class="file" href="../wai-handler-webkit/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../wai-handler-webkit/sample.hs.html">sample.hs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai-websockets</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Handler</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../wai-websockets/Network/Wai/Handler/WebSockets.hs.html">WebSockets.hs</a></div></div></div></div></div></div></div><div class="node-path"><a class="file" href="../wai-websockets/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../wai-websockets/server.lhs.html">server.lhs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> warp</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Handler</div>
<div class="node-body"><div class="node" level=5><div class="node-title"><i class="fa fa-angle-right carrot"></i> Warp</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Buffer.hs.html">Buffer.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Conduit.hs.html">Conduit.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Counter.hs.html">Counter.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Date.hs.html">Date.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/FdCache.hs.html">FdCache.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Header.hs.html">Header.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/IO.hs.html">IO.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/IORef.hs.html">IORef.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Internal.hs.html">Internal.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/MultiMap.hs.html">MultiMap.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/ReadInt.hs.html">ReadInt.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Recv.hs.html">Recv.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Request.hs.html">Request.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/RequestHeader.hs.html">RequestHeader.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Response.hs.html">Response.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/ResponseHeader.hs.html">ResponseHeader.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Run.hs.html">Run.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/SendFile.hs.html">SendFile.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Settings.hs.html">Settings.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Timeout.hs.html">Timeout.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Types.hs.html">Types.hs</a></div><div class="node-path"><a class="file" href="../../../../../warp/Network/Wai/Handler/Warp/Windows.hs.html">Windows.hs</a></div></div></div><div class="node-path"><a class="file" href="../../../../warp/Network/Wai/Handler/Warp.hs.html">Warp.hs</a></div></div></div></div></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> test</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../warp/test/ConduitSpec.hs.html">ConduitSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/ExceptionSpec.hs.html">ExceptionSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/FdCacheSpec.hs.html">FdCacheSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/MultiMapSpec.hs.html">MultiMapSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/ReadIntSpec.hs.html">ReadIntSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/RequestSpec.hs.html">RequestSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/ResponseHeaderSpec.hs.html">ResponseHeaderSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/ResponseSpec.hs.html">ResponseSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/RunSpec.hs.html">RunSpec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/Spec.hs.html">Spec.hs</a></div><div class="node-path"><a class="file" href="../../warp/test/doctests.hs.html">doctests.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> bench</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../warp/bench/Parser.hs.html">Parser.hs</a></div></div></div><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> attic</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../warp/attic/bigtable-single.hs.html">bigtable-single.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/bigtable-stream.hs.html">bigtable-stream.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/file-nolen.hs.html">file-nolen.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/file.hs.html">file.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/pong.hs.html">pong.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/print-post.hs.html">print-post.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/readInt.hs.html">readInt.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/runtests.hs.html">runtests.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/server-no-keepalive.hs.html">server-no-keepalive.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/statuses.hs.html">statuses.hs</a></div><div class="node-path"><a class="file" href="../../warp/attic/undrained.hs.html">undrained.hs</a></div></div></div><div class="node-path"><a class="file" href="../warp/Setup.lhs.html">Setup.lhs</a></div></div></div><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> warp-tls</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node" level=3><div class="node-title"><i class="fa fa-angle-right carrot"></i> Wai</div>
<div class="node-body"><div class="node" level=4><div class="node-title"><i class="fa fa-angle-right carrot"></i> Handler</div>
<div class="node-body"><div class="node-path"><a class="file" href="../../../../warp-tls/Network/Wai/Handler/WarpTLS.hs.html">WarpTLS.hs</a></div></div></div></div></div></div></div><div class="node-path"><a class="file" href="../warp-tls/Setup.lhs.html">Setup.lhs</a></div><div class="node-path"><a class="file" href="../warp-tls/graceful-pong.hs.html">graceful-pong.hs</a></div><div class="node-path"><a class="file" href="../warp-tls/pong.hs.html">pong.hs</a></div></div></div></div></div>
      </div>
      <div id="defs-toc" class="toc">
        <div class="node" level=0><div class="node-title"><i class="fa fa-angle-right carrot"></i> all defs</div>
<div class="node-body"><div class="node" level=1><div class="node-title"><i class="fa fa-angle-right carrot"></i> wai</div>
<div class="node-body"><div class="node" level=2><div class="node-title"><i class="fa fa-angle-right carrot"></i> Network</div>
<div class="node-body"><div class="node-path"><a class="def" href="../../wai/Network/Wai.hs.html#wai/wai/Network/Wai">Wai</a> - Module</div></div></div></div></div></div></div>
      </div>
    </div>
    <div class="grid">
      
      <div class="row">
        <div class="doc">&nbsp;</div>
        <div class="code"><span class="def" id="wai/wai/Network/Wai"></span><span class="pun">{</span><span class="pun">-</span><span class="pun">#</span> <span class="typ">LANGUAGE</span> <span class="typ">Rank2Types</span> <span class="pun">#</span><span class="pun">-</span><span class="pun">}</span>
<span class="pun">{</span><span class="pun">-</span><span class="pun">#</span> <span class="typ">LANGUAGE</span> <span class="typ">CPP</span> <span class="pun">#</span><span class="pun">-</span><span class="pun">}</span>
<span class="pun">{</span><span class="pun">-</span><span class="pun">|</span>

<span class="typ">This</span> <span class="kwd">module</span> <span class="pln">defines</span> <span class="pln">a</span> <span class="kwd">generic</span> <span class="pln">web</span> <span class="pln">application</span> <span class="kwd">interface</span><span class="pun">.</span> <span class="typ">It</span> <span class="kwd">is</span> <span class="pln">a</span> <span class="pln">common</span>
<span class="pln">protocol</span> <span class="pln">between</span> <span class="pln">web</span> <span class="pln">servers</span> <span class="kwd">and</span> <span class="pln">web</span> <span class="pln">applications</span><span class="pun">.</span>

<span class="typ">The</span> <span class="pln">overriding</span> <span class="pln">design</span> <span class="pln">principles</span> <span class="pln">here</span> <span class="pln">are</span> <span class="pln">performance</span> <span class="kwd">and</span> <span class="pln">generality</span><span class="pun">.</span> <span class="typ">To</span>
<span class="pln">address</span> <span class="pln">performance</span><span class="pun">,</span> <span class="kwd">this</span> <span class="pln">library</span> <span class="kwd">is</span> <span class="pln">built</span> <span class="pln">on</span> <span class="pln">top</span> <span class="pln">of</span> <span class="pln">the</span> <span class="pln">conduit</span> <span class="kwd">and</span>
<span class="pln">blaze</span><span class="pun">-</span><span class="pln">builder</span> <span class="pln">packages</span><span class="pun">.</span>  <span class="typ">The</span> <span class="pln">advantages</span> <span class="pln">of</span> <span class="pln">conduits</span> <span class="pln">over</span> <span class="pln">lazy</span> <span class="typ">IO</span> <span class="pln">have</span> <span class="pln">been</span>
<span class="pln">debated</span> <span class="pln">elsewhere</span> <span class="kwd">and</span> <span class="pln">so</span> <span class="pln">will</span> <span class="kwd">not</span> <span class="pln">be</span> <span class="pln">addressed</span> <span class="pln">here</span><span class="pun">.</span>  <span class="typ">However</span><span class="pun">,</span> <span class="pln">helper</span> <span class="pln">functions</span>
<span class="pln">like</span> <span class="str">&#39;responseLBS&#39;</span> <span class="pln">allow</span> <span class="pln">you</span> <span class="pln">to</span> <span class="kwd">continue</span> <span class="kwd">using</span> <span class="pln">lazy</span> <span class="typ">IO</span> <span class="kwd">if</span> <span class="pln">you</span> <span class="pln">so</span> <span class="pln">desire</span><span class="pun">.</span>

<span class="typ">Generality</span> <span class="kwd">is</span> <span class="pln">achieved</span> <span class="pln">by</span> <span class="pln">removing</span> <span class="pln">many</span> <span class="pln">variables</span> <span class="pln">commonly</span> <span class="pln">found</span> <span class="kwd">in</span> <span class="pln">similar</span>
<span class="pln">projects</span> <span class="pln">that</span> <span class="pln">are</span> <span class="kwd">not</span> <span class="pln">universal</span> <span class="pln">to</span> <span class="pln">all</span> <span class="pln">servers</span><span class="pun">.</span> <span class="typ">The</span> <span class="pln">goal</span> <span class="kwd">is</span> <span class="pln">that</span> <span class="pln">the</span> <span class="str">&#39;Request&#39;</span>
<span class="pln">object</span> <span class="pln">contains</span> <span class="pln">only</span> <span class="pln">data</span> <span class="pln">which</span> <span class="kwd">is</span> <span class="pln">meaningful</span> <span class="kwd">in</span> <span class="pln">all</span> <span class="pln">circumstances</span><span class="pun">.</span>

<span class="typ">Please</span> <span class="pln">remember</span> <span class="kwd">when</span> <span class="kwd">using</span> <span class="kwd">this</span> <span class="kwd">package</span> <span class="pln">that</span><span class="pun">,</span> <span class="kwd">while</span> <span class="pln">your</span> <span class="pln">application</span> <span class="pln">may</span>
<span class="pln">compile</span> <span class="pln">without</span> <span class="pln">a</span> <span class="pln">hitch</span> <span class="pln">against</span> <span class="pln">many</span> <span class="pln">different</span> <span class="pln">servers</span><span class="pun">,</span> <span class="pln">there</span> <span class="pln">are</span> <span class="pln">other</span>
<span class="pln">considerations</span> <span class="pln">to</span> <span class="pln">be</span> <span class="pln">taken</span> <span class="kwd">when</span> <span class="pln">moving</span> <span class="pln">to</span> <span class="pln">a</span> <span class="kwd">new</span> <span class="pln">backend</span><span class="pun">.</span> <span class="typ">For</span> <span class="pln">example</span><span class="pun">,</span> <span class="kwd">if</span> <span class="pln">you</span>
<span class="pln">transfer</span> <span class="kwd">from</span> <span class="pln">a</span> <span class="typ">CGI</span> <span class="pln">application</span> <span class="pln">to</span> <span class="pln">a</span> <span class="typ">FastCGI</span> <span class="pln">one</span><span class="pun">,</span> <span class="pln">you</span> <span class="pln">might</span> <span class="pln">suddenly</span> <span class="pln">find</span> <span class="pln">you</span>
<span class="pln">have</span> <span class="pln">a</span> <span class="pln">memory</span> <span class="pln">leak</span><span class="pun">.</span> <span class="typ">Conversely</span><span class="pun">,</span> <span class="pln">a</span> <span class="typ">FastCGI</span> <span class="pln">application</span> <span class="pln">would</span> <span class="pln">be</span> <span class="pln">well</span> <span class="pln">served</span> <span class="pln">to</span>
<span class="pln">preload</span> <span class="pln">all</span> <span class="pln">templates</span> <span class="kwd">from</span> <span class="pln">disk</span> <span class="kwd">when</span> <span class="pln">first</span> <span class="pln">starting</span><span class="pun">;</span> <span class="kwd">this</span> <span class="pln">would</span> <span class="pln">kill</span> <span class="pln">the</span>
<span class="pln">performance</span> <span class="pln">of</span> <span class="pln">a</span> <span class="typ">CGI</span> <span class="pln">application</span><span class="pun">.</span>

<span class="typ">This</span> <span class="kwd">package</span> <span class="pln">purposely</span> <span class="pln">provides</span> <span class="pln">very</span> <span class="pln">little</span> <span class="pln">functionality</span><span class="pun">.</span> <span class="typ">You</span> <span class="pln">can</span> <span class="pln">find</span> <span class="pln">various</span>
<span class="pln">middlewares</span><span class="pun">,</span> <span class="pln">backends</span> <span class="kwd">and</span> <span class="pln">utilities</span> <span class="pln">on</span> <span class="typ">Hackage</span><span class="pun">.</span> <span class="typ">Some</span> <span class="pln">of</span> <span class="pln">the</span> <span class="pln">most</span> <span class="pln">commonly</span> <span class="pln">used</span>
<span class="pln">include</span><span class="pun">:</span>

<span class="pun">[</span><span class="pln">warp</span><span class="pun">]</span> <span class="pun">&lt;</span><span class="pln">http</span><span class="pun">:</span><span class="com">//hackage.haskell.org/package/warp&gt;</span>

<span class="pun">[</span><span class="pln">wai</span><span class="pun">-</span><span class="pln">extra</span><span class="pun">]</span> <span class="pun">&lt;</span><span class="pln">http</span><span class="pun">:</span><span class="com">//hackage.haskell.org/package/wai-extra&gt;</span>

<span class="pun">[</span><span class="pln">wai</span><span class="pun">-</span><span class="pln">test</span><span class="pun">]</span> <span class="pun">&lt;</span><span class="pln">http</span><span class="pun">:</span><span class="com">//hackage.haskell.org/package/wai-test&gt;</span>

<span class="pun">-</span><span class="pun">}</span>
<span class="kwd">module</span> <span class="typ">Network</span><span class="pun">.</span><span class="typ">Wai</span>
    <span class="pun">(</span>
      <span class="pun">-</span><span class="pun">-</span> <span class="pun">*</span> <span class="typ">Types</span>
      <span class="typ">Application</span>
    <span class="pun">,</span> <span class="typ">Middleware</span>
    <span class="pun">,</span> <span class="typ">ResponseReceived</span>
      <span class="pun">-</span><span class="pun">-</span> <span class="pun">*</span> <span class="typ">Request</span>
    <span class="pun">,</span> <span class="typ">Request</span>
    <span class="pun">,</span> <span class="pln">defaultRequest</span>
    <span class="pun">,</span> <span class="typ">RequestBodyLength</span> <span class="pun">(</span><span class="pun">.</span><span class="pun">.</span><span class="pun">)</span>
      <span class="pun">-</span><span class="pun">-</span> <span class="pun">*</span><span class="pun">*</span> <span class="typ">Request</span> <span class="pln">accessors</span>
    <span class="pun">,</span> <span class="pln">requestMethod</span>
    <span class="pun">,</span> <span class="pln">httpVersion</span>
    <span class="pun">,</span> <span class="pln">rawPathInfo</span>
    <span class="pun">,</span> <span class="pln">rawQueryString</span>
    <span class="pun">,</span> <span class="pln">requestHeaders</span>
    <span class="pun">,</span> <span class="pln">isSecure</span>
    <span class="pun">,</span> <span class="pln">remoteHost</span>
    <span class="pun">,</span> <span class="pln">pathInfo</span>
    <span class="pun">,</span> <span class="pln">queryString</span>
    <span class="pun">,</span> <span class="pln">requestBody</span>
    <span class="pun">,</span> <span class="pln">vault</span>
    <span class="pun">,</span> <span class="pln">requestBodyLength</span>
    <span class="pun">,</span> <span class="pln">requestHeaderHost</span>
    <span class="pun">,</span> <span class="pln">requestHeaderRange</span>
    <span class="pun">,</span> <span class="pln">strictRequestBody</span>
    <span class="pun">,</span> <span class="pln">lazyRequestBody</span>
      <span class="pun">-</span><span class="pun">-</span> <span class="pun">*</span> <span class="typ">Response</span>
    <span class="pun">,</span> <span class="typ">Response</span>
    <span class="pun">,</span> <span class="typ">StreamingBody</span>
    <span class="pun">,</span> <span class="typ">FilePart</span> <span class="pun">(</span><span class="pun">.</span><span class="pun">.</span><span class="pun">)</span>
      <span class="pun">-</span><span class="pun">-</span> <span class="pun">*</span><span class="pun">*</span> <span class="typ">Response</span> <span class="pln">composers</span>
    <span class="pun">,</span> <span class="pln">responseFile</span>
    <span class="pun">,</span> <span class="pln">responseBuilder</span>
    <span class="pun">,</span> <span class="pln">responseLBS</span>
    <span class="pun">,</span> <span class="pln">responseStream</span>
    <span class="pun">,</span> <span class="pln">responseRaw</span>
      <span class="pun">-</span><span class="pun">-</span> <span class="pun">*</span> <span class="typ">Response</span> <span class="pln">accessors</span>
    <span class="pun">,</span> <span class="pln">responseStatus</span>
    <span class="pun">,</span> <span class="pln">responseHeaders</span>
    <span class="pun">,</span> <span class="pln">responseToStream</span>
    <span class="pun">)</span> <span class="kwd">where</span>

<span class="kwd">import</span>           <span class="typ">Blaze</span><span class="pun">.</span><span class="typ">ByteString</span><span class="pun">.</span><span class="typ">Builder</span>     <span class="pun">(</span><span class="typ">Builder</span><span class="pun">,</span> <span class="pln">fromLazyByteString</span><span class="pun">)</span>
<span class="kwd">import</span>           <span class="typ">Blaze</span><span class="pun">.</span><span class="typ">ByteString</span><span class="pun">.</span><span class="typ">Builder</span>     <span class="pun">(</span><span class="pln">fromByteString</span><span class="pun">)</span>
<span class="kwd">import</span>           <span class="typ">Control</span><span class="pun">.</span><span class="typ">Monad</span>                <span class="pun">(</span><span class="kwd">unless</span><span class="pun">)</span>
<span class="kwd">import</span> <span class="pln">qualified</span> <span class="typ">Data</span><span class="pun">.</span><span class="typ">ByteString</span>              <span class="kwd">as</span> <span class="typ">B</span>
<span class="kwd">import</span> <span class="pln">qualified</span> <span class="typ">Data</span><span class="pun">.</span><span class="typ">ByteString</span><span class="pun">.</span><span class="typ">Lazy</span>         <span class="kwd">as</span> <span class="typ">L</span>
<span class="kwd">import</span> <span class="pln">qualified</span> <span class="typ">Data</span><span class="pun">.</span><span class="typ">ByteString</span><span class="pun">.</span><span class="typ">Lazy</span><span class="pun">.</span><span class="typ">Internal</span> <span class="kwd">as</span> <span class="typ">LI</span>
<span class="kwd">import</span>           <span class="typ">Data</span><span class="pun">.</span><span class="typ">ByteString</span><span class="pun">.</span><span class="typ">Lazy</span><span class="pun">.</span><span class="typ">Internal</span> <span class="pun">(</span><span class="pln">defaultChunkSize</span><span class="pun">)</span>
<span class="kwd">import</span>           <span class="typ">Data</span><span class="pun">.</span><span class="typ">ByteString</span><span class="pun">.</span><span class="typ">Lazy</span><span class="pun">.</span><span class="typ">Char8</span>   <span class="pun">(</span><span class="pun">)</span>
<span class="kwd">import</span>           <span class="typ">Data</span><span class="pun">.</span><span class="typ">Function</span>                <span class="pun">(</span><span class="pln">fix</span><span class="pun">)</span>
<span class="kwd">import</span>           <span class="typ">Data</span><span class="pun">.</span><span class="typ">Monoid</span>                  <span class="pun">(</span><span class="pln">mempty</span><span class="pun">)</span>
<span class="kwd">import</span> <span class="pln">qualified</span> <span class="typ">Network</span><span class="pun">.</span><span class="typ">HTTP</span><span class="pun">.</span><span class="typ">Types</span>           <span class="kwd">as</span> <span class="typ">H</span>
<span class="kwd">import</span>           <span class="typ">Network</span><span class="pun">.</span><span class="typ">Socket</span>               <span class="pun">(</span><span class="typ">SockAddr</span> <span class="pun">(</span><span class="typ">SockAddrInet</span><span class="pun">)</span><span class="pun">)</span>
<span class="kwd">import</span>           <span class="typ">Network</span><span class="pun">.</span><span class="typ">Wai</span><span class="pun">.</span><span class="typ">Internal</span>
<span class="kwd">import</span> <span class="pln">qualified</span> <span class="typ">System</span><span class="pun">.</span><span class="typ">IO</span>                    <span class="kwd">as</span> <span class="typ">IO</span>
<span class="kwd">import</span>           <span class="typ">System</span><span class="pun">.</span><span class="typ">IO</span><span class="pun">.</span><span class="typ">Unsafe</span>             <span class="pun">(</span><span class="pln">unsafeInterleaveIO</span><span class="pun">)</span>

<span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Creating</span> <span class="str">&#39;Response&#39;</span> <span class="kwd">from</span> <span class="pln">a</span> <span class="pln">file</span><span class="pun">.</span>
<span class="pln">responseFile</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">Status</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">ResponseHeaders</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">FilePath</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Maybe</span> <span class="typ">FilePart</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Response</span>
<span class="pln">responseFile</span> <span class="pun">=</span> <span class="typ">ResponseFile</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Creating</span> <span class="str">&#39;Response&#39;</span> <span class="kwd">from</span> <span class="str">&#39;Builder&#39;</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Some</span> <span class="pln">questions</span> <span class="kwd">and</span> <span class="pln">answers</span> <span class="pln">about</span> <span class="pln">the</span> <span class="pln">usage</span> <span class="pln">of</span> <span class="str">&#39;Builder&#39;</span> <span class="pln">here</span><span class="pun">:</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Q1</span><span class="pun">.</span> <span class="typ">Shouldn</span><span class="str">&#39;t it be at the user&#39;</span><span class="pln">s</span> <span class="pln">discretion</span> <span class="pln">to</span> <span class="kwd">use</span> <span class="typ">Builders</span> <span class="pln">internally</span> <span class="kwd">and</span>
<span class="pun">-</span><span class="pun">-</span> <span class="kwd">then</span> <span class="pln">create</span> <span class="pln">a</span> <span class="pln">stream</span> <span class="pln">of</span> <span class="typ">ByteStrings</span><span class="pun">?</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">A1</span><span class="pun">.</span> <span class="typ">That</span> <span class="pln">would</span> <span class="pln">be</span> <span class="pln">less</span> <span class="pln">efficient</span><span class="pun">,</span> <span class="kwd">as</span> <span class="pln">we</span> <span class="pln">wouldn</span><span class="str">&#39;t get cheap concatenation
</span><span class="pun">-</span><span class="pun">-</span> <span class="kwd">with</span> <span class="pln">the</span> <span class="pln">response</span> <span class="pln">headers</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Q2</span><span class="pun">.</span> <span class="typ">Isn</span><span class="str">&#39;t it really inefficient to convert from ByteString to Builder, and
</span><span class="pun">-</span><span class="pun">-</span> <span class="kwd">then</span> <span class="pln">right</span> <span class="pln">back</span> <span class="pln">to</span> <span class="typ">ByteString</span><span class="pun">?</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">A2</span><span class="pun">.</span> <span class="typ">No</span><span class="pun">.</span> <span class="typ">If</span> <span class="pln">the</span> <span class="typ">ByteStrings</span> <span class="pln">are</span> <span class="pln">small</span><span class="pun">,</span> <span class="kwd">then</span> <span class="pln">they</span> <span class="pln">will</span> <span class="pln">be</span> <span class="pln">copied</span> <span class="pln">into</span> <span class="pln">a</span> <span class="pln">larger</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">buffer</span><span class="pun">,</span> <span class="pln">which</span> <span class="pln">should</span> <span class="pln">be</span> <span class="pln">a</span> <span class="pln">performance</span> <span class="pln">gain</span> <span class="pln">overall</span> <span class="pun">(</span><span class="pln">less</span> <span class="pln">system</span> <span class="pln">calls</span><span class="pun">)</span><span class="pun">.</span> <span class="typ">If</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">they</span> <span class="pln">are</span> <span class="pln">already</span> <span class="pln">large</span><span class="pun">,</span> <span class="kwd">then</span> <span class="pln">blaze</span><span class="pun">-</span><span class="pln">builder</span> <span class="pln">uses</span> <span class="pln">an</span> <span class="typ">InsertByteString</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">instruction</span> <span class="pln">to</span> <span class="pln">avoid</span> <span class="pln">copying</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Q3</span><span class="pun">.</span> <span class="typ">Doesn</span><span class="str">&#39;t this prevent us from creating comet-style servers, since data
</span><span class="pun">-</span><span class="pun">-</span> <span class="pln">will</span> <span class="pln">be</span> <span class="pln">cached</span><span class="pun">?</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">A3</span><span class="pun">.</span> <span class="typ">You</span> <span class="pln">can</span> <span class="pln">force</span> <span class="pln">blaze</span><span class="pun">-</span><span class="pln">builder</span> <span class="pln">to</span> <span class="pln">output</span> <span class="pln">a</span> <span class="typ">ByteString</span> <span class="pln">before</span> <span class="pln">it</span> <span class="kwd">is</span> <span class="pln">an</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">optimal</span> <span class="pln">size</span> <span class="pln">by</span> <span class="pln">sending</span> <span class="pln">a</span> <span class="pln">flush</span> <span class="pln">command</span><span class="pun">.</span>
<span class="pln">responseBuilder</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">Status</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">ResponseHeaders</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Builder</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Response</span>
<span class="pln">responseBuilder</span> <span class="pun">=</span> <span class="typ">ResponseBuilder</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Creating</span> <span class="str">&#39;Response&#39;</span> <span class="kwd">from</span> <span class="str">&#39;L.ByteString&#39;</span><span class="pun">.</span> <span class="typ">This</span> <span class="kwd">is</span> <span class="pln">a</span> <span class="pln">wrapper</span> <span class="kwd">for</span>
<span class="pun">-</span><span class="pun">-</span>   <span class="str">&#39;responseBuilder&#39;</span><span class="pun">.</span>
<span class="pln">responseLBS</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">Status</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">ResponseHeaders</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">L</span><span class="pun">.</span><span class="typ">ByteString</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Response</span>
<span class="pln">responseLBS</span> <span class="pln">s</span> <span class="pln">h</span> <span class="pun">=</span> <span class="typ">ResponseBuilder</span> <span class="pln">s</span> <span class="pln">h</span> <span class="pun">.</span> <span class="pln">fromLazyByteString</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Creating</span> <span class="str">&#39;Response&#39;</span> <span class="kwd">from</span> <span class="pln">a</span> <span class="pln">stream</span> <span class="pln">of</span> <span class="pln">values</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">In</span> <span class="pln">order</span> <span class="pln">to</span> <span class="pln">allocate</span> <span class="pln">resources</span> <span class="kwd">in</span> <span class="pln">an</span> <span class="pln">exception</span><span class="pun">-</span><span class="pln">safe</span> <span class="pln">manner</span><span class="pun">,</span> <span class="pln">you</span> <span class="pln">can</span> <span class="kwd">use</span> <span class="pln">the</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span><span class="pln">bracket</span><span class="pun">@</span> <span class="pln">pattern</span> <span class="pln">outside</span> <span class="pln">of</span> <span class="pln">the</span> <span class="pln">call</span> <span class="pln">to</span> <span class="pun">@</span><span class="pln">responseStream</span><span class="pun">@</span><span class="pun">.</span> <span class="typ">As</span> <span class="pln">a</span> <span class="pln">trivial</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">example</span><span class="pun">:</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">app</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Application</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">app</span> <span class="pln">req</span> <span class="pln">respond</span> <span class="pun">=</span> <span class="pln">bracket_</span>
<span class="pun">-</span><span class="pun">-</span>     <span class="pun">(</span><span class="pln">putStrLn</span> <span class="pun">\</span><span class="str">&#34;Allocating scarce resource\&#34;)
</span><span class="pun">-</span><span class="pun">-</span>     <span class="pun">(</span><span class="pln">putStrLn</span> <span class="pun">\</span><span class="str">&#34;Cleaning up\&#34;)
</span><span class="pun">-</span><span class="pun">-</span>     <span class="pun">$</span> <span class="pln">respond</span> <span class="pun">$</span> <span class="pln">responseStream</span> <span class="pln">status200</span> <span class="pun">[</span><span class="pun">]</span> <span class="pun">$</span> <span class="pun">\</span><span class="pun">\</span><span class="pln">write</span> <span class="pln">flush</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="kwd">do</span>
<span class="pun">-</span><span class="pun">-</span>         <span class="pln">write</span> <span class="pun">$</span> <span class="pln">fromByteString</span> <span class="pun">\</span><span class="str">&#34;Hello\\n\&#34;
</span><span class="pun">-</span><span class="pun">-</span>         <span class="pln">flush</span>
<span class="pun">-</span><span class="pun">-</span>         <span class="pln">write</span> <span class="pun">$</span> <span class="pln">fromByteString</span> <span class="pun">\</span><span class="str">&#34;World\\n\&#34;
</span><span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Note</span> <span class="pln">that</span> <span class="kwd">in</span> <span class="pln">some</span> <span class="pln">cases</span> <span class="pln">you</span> <span class="pln">can</span> <span class="kwd">use</span> <span class="pun">@</span><span class="pln">bracket</span><span class="pun">@</span> <span class="kwd">from</span> <span class="pln">inside</span> <span class="pun">@</span><span class="pln">responseStream</span><span class="pun">@</span>
<span class="pun">-</span><span class="pun">-</span> <span class="kwd">as</span> <span class="pln">well</span><span class="pun">.</span> <span class="typ">However</span><span class="pun">,</span> <span class="pln">placing</span> <span class="pln">the</span> <span class="pln">call</span> <span class="pln">on</span> <span class="pln">the</span> <span class="pln">outside</span> <span class="pln">allows</span> <span class="pln">your</span> <span class="pln">status</span> <span class="pln">value</span>
<span class="pun">-</span><span class="pun">-</span> <span class="kwd">and</span> <span class="pln">response</span> <span class="pln">headers</span> <span class="pln">to</span> <span class="pln">depend</span> <span class="pln">on</span> <span class="pln">the</span> <span class="pln">scarce</span> <span class="pln">resource</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Since</span> <span class="dec">3.0</span><span class="dec">.0</span>
<span class="pln">responseStream</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">Status</span>
               <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">ResponseHeaders</span>
               <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">StreamingBody</span>
               <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Response</span>
<span class="pln">responseStream</span> <span class="pun">=</span> <span class="typ">ResponseStream</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Create</span> <span class="pln">a</span> <span class="pln">response</span> <span class="kwd">for</span> <span class="pln">a</span> <span class="pln">raw</span> <span class="pln">application</span><span class="pun">.</span> <span class="typ">This</span> <span class="kwd">is</span> <span class="pln">useful</span> <span class="kwd">for</span> <span class="pun">\</span><span class="str">&#34;upgrade\&#34;
</span><span class="pun">-</span><span class="pun">-</span> <span class="pln">situations</span> <span class="pln">such</span> <span class="kwd">as</span> <span class="typ">WebSockets</span><span class="pun">,</span> <span class="kwd">where</span> <span class="pln">an</span> <span class="pln">application</span> <span class="pln">requests</span> <span class="kwd">for</span> <span class="pln">the</span> <span class="pln">server</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">to</span> <span class="pln">grant</span> <span class="pln">it</span> <span class="pln">raw</span> <span class="pln">network</span> <span class="pln">access</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">This</span> <span class="kwd">function</span> <span class="pln">requires</span> <span class="pln">a</span> <span class="pln">backup</span> <span class="pln">response</span> <span class="pln">to</span> <span class="pln">be</span> <span class="pln">provided</span><span class="pun">,</span> <span class="kwd">for</span> <span class="pln">the</span> <span class="kwd">case</span> <span class="kwd">where</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">the</span> <span class="pln">handler</span> <span class="kwd">in</span> <span class="pln">question</span> <span class="pln">does</span> <span class="kwd">not</span> <span class="pln">support</span> <span class="pln">such</span> <span class="pln">upgrading</span> <span class="pun">(</span><span class="pln">e</span><span class="pun">.</span><span class="pln">g</span><span class="pun">.</span><span class="pun">,</span> <span class="typ">CGI</span> <span class="pln">apps</span><span class="pun">)</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">In</span> <span class="pln">the</span> <span class="pln">event</span> <span class="pln">that</span> <span class="pln">you</span> <span class="pln">read</span> <span class="kwd">from</span> <span class="pln">the</span> <span class="pln">request</span> <span class="pln">body</span> <span class="pln">before</span> <span class="pln">returning</span> <span class="pln">a</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span><span class="pln">responseRaw</span><span class="pun">@</span><span class="pun">,</span> <span class="pln">behavior</span> <span class="kwd">is</span> <span class="kwd">undefined</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Since</span> <span class="dec">2.1</span><span class="dec">.0</span>
<span class="pln">responseRaw</span> <span class="pun">:</span><span class="pun">:</span> <span class="pun">(</span><span class="typ">IO</span> <span class="typ">B</span><span class="pun">.</span><span class="typ">ByteString</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="pun">(</span><span class="typ">B</span><span class="pun">.</span><span class="typ">ByteString</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="pun">(</span><span class="pun">)</span><span class="pun">)</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
            <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Response</span>
            <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Response</span>
<span class="pln">responseRaw</span> <span class="pun">=</span> <span class="typ">ResponseRaw</span>

<span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Accessing</span> <span class="str">&#39;H.Status&#39;</span> <span class="kwd">in</span> <span class="str">&#39;Response&#39;</span><span class="pun">.</span>
<span class="pln">responseStatus</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Response</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">Status</span>
<span class="pln">responseStatus</span> <span class="pun">(</span><span class="typ">ResponseFile</span>    <span class="pln">s</span> <span class="pln">_</span> <span class="pln">_</span> <span class="pln">_</span><span class="pun">)</span> <span class="pun">=</span> <span class="pln">s</span>
<span class="pln">responseStatus</span> <span class="pun">(</span><span class="typ">ResponseBuilder</span> <span class="pln">s</span> <span class="pln">_</span> <span class="pln">_</span>  <span class="pun">)</span> <span class="pun">=</span> <span class="pln">s</span>
<span class="pln">responseStatus</span> <span class="pun">(</span><span class="typ">ResponseStream</span>  <span class="pln">s</span> <span class="pln">_</span> <span class="pln">_</span>  <span class="pun">)</span> <span class="pun">=</span> <span class="pln">s</span>
<span class="pln">responseStatus</span> <span class="pun">(</span><span class="typ">ResponseRaw</span> <span class="pln">_</span> <span class="pln">res</span>      <span class="pun">)</span> <span class="pun">=</span> <span class="pln">responseStatus</span> <span class="pln">res</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Accessing</span> <span class="str">&#39;H.ResponseHeaders&#39;</span> <span class="kwd">in</span> <span class="str">&#39;Response&#39;</span><span class="pun">.</span>
<span class="pln">responseHeaders</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Response</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">ResponseHeaders</span>
<span class="pln">responseHeaders</span> <span class="pun">(</span><span class="typ">ResponseFile</span>    <span class="pln">_</span> <span class="pln">hs</span> <span class="pln">_</span> <span class="pln">_</span><span class="pun">)</span> <span class="pun">=</span> <span class="pln">hs</span>
<span class="pln">responseHeaders</span> <span class="pun">(</span><span class="typ">ResponseBuilder</span> <span class="pln">_</span> <span class="pln">hs</span> <span class="pln">_</span>  <span class="pun">)</span> <span class="pun">=</span> <span class="pln">hs</span>
<span class="pln">responseHeaders</span> <span class="pun">(</span><span class="typ">ResponseStream</span>  <span class="pln">_</span> <span class="pln">hs</span> <span class="pln">_</span>  <span class="pun">)</span> <span class="pun">=</span> <span class="pln">hs</span>
<span class="pln">responseHeaders</span> <span class="pun">(</span><span class="typ">ResponseRaw</span> <span class="pln">_</span> <span class="pln">res</span><span class="pun">)</span>        <span class="pun">=</span> <span class="pln">responseHeaders</span> <span class="pln">res</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Converting</span> <span class="pln">the</span> <span class="pln">body</span> <span class="pln">information</span> <span class="kwd">in</span> <span class="str">&#39;Response&#39;</span> <span class="pln">to</span> <span class="pln">a</span> <span class="str">&#39;StreamingBody&#39;</span><span class="pun">.</span>
<span class="pln">responseToStream</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Response</span>
                 <span class="pun">-</span><span class="pun">&gt;</span> <span class="pun">(</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">Status</span>
                    <span class="pun">,</span> <span class="typ">H</span><span class="pun">.</span><span class="typ">ResponseHeaders</span>
                    <span class="pun">,</span> <span class="pun">(</span><span class="typ">StreamingBody</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="pln">a</span><span class="pun">)</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="pln">a</span>
                    <span class="pun">)</span>
<span class="pln">responseToStream</span> <span class="pun">(</span><span class="typ">ResponseStream</span> <span class="pln">s</span> <span class="pln">h</span> <span class="pln">b</span><span class="pun">)</span> <span class="pun">=</span> <span class="pun">(</span><span class="pln">s</span><span class="pun">,</span> <span class="pln">h</span><span class="pun">,</span> <span class="pun">(</span><span class="pun">$</span> <span class="pln">b</span><span class="pun">)</span><span class="pun">)</span>
<span class="pln">responseToStream</span> <span class="pun">(</span><span class="typ">ResponseFile</span> <span class="pln">s</span> <span class="pln">h</span> <span class="pln">fp</span> <span class="pun">(</span><span class="typ">Just</span> <span class="pln">part</span><span class="pun">)</span><span class="pun">)</span> <span class="pun">=</span>
    <span class="pun">(</span> <span class="pln">s</span>
    <span class="pun">,</span> <span class="pln">h</span>
    <span class="pun">,</span> <span class="pun">\</span><span class="pln">withBody</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span><span class="pun">.</span><span class="pln">withBinaryFile</span> <span class="pln">fp</span> <span class="typ">IO</span><span class="pun">.</span><span class="typ">ReadMode</span> <span class="pun">$</span> <span class="pun">\</span><span class="pln">handle</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="pln">withBody</span> <span class="pun">$</span> <span class="pun">\</span><span class="pln">sendChunk</span> <span class="pln">_flush</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="kwd">do</span>
        <span class="typ">IO</span><span class="pun">.</span><span class="pln">hSeek</span> <span class="pln">handle</span> <span class="typ">IO</span><span class="pun">.</span><span class="typ">AbsoluteSeek</span> <span class="pun">$</span> <span class="pln">filePartOffset</span> <span class="pln">part</span>
        <span class="pln">let</span> <span class="pln">loop</span> <span class="pln">remaining</span> <span class="pun">|</span> <span class="pln">remaining</span> <span class="pun">&lt;</span><span class="pun">=</span> <span class="dec">0</span> <span class="pun">=</span> <span class="kwd">return</span> <span class="pun">(</span><span class="pun">)</span>
            <span class="pln">loop</span> <span class="pln">remaining</span> <span class="pun">=</span> <span class="kwd">do</span>
                <span class="pln">bs</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">hGetSome</span> <span class="pln">handle</span> <span class="pln">defaultChunkSize</span>
                <span class="kwd">unless</span> <span class="pun">(</span><span class="typ">B</span><span class="pun">.</span><span class="kwd">null</span> <span class="pln">bs</span><span class="pun">)</span> <span class="pun">$</span> <span class="kwd">do</span>
                    <span class="pln">let</span> <span class="pln">x</span> <span class="pun">=</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">take</span> <span class="pln">remaining</span> <span class="pln">bs</span>
                    <span class="pln">sendChunk</span> <span class="pun">$</span> <span class="pln">fromByteString</span> <span class="pln">x</span>
                    <span class="pln">loop</span> <span class="pun">$</span> <span class="pln">remaining</span> <span class="pun">-</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">length</span> <span class="pln">x</span>
        <span class="pln">loop</span> <span class="pun">$</span> <span class="pln">fromIntegral</span> <span class="pun">$</span> <span class="pln">filePartByteCount</span> <span class="pln">part</span>
    <span class="pun">)</span>
<span class="pln">responseToStream</span> <span class="pun">(</span><span class="typ">ResponseFile</span> <span class="pln">s</span> <span class="pln">h</span> <span class="pln">fp</span> <span class="typ">Nothing</span><span class="pun">)</span> <span class="pun">=</span>
    <span class="pun">(</span> <span class="pln">s</span>
    <span class="pun">,</span> <span class="pln">h</span>
    <span class="pun">,</span> <span class="pun">\</span><span class="pln">withBody</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span><span class="pun">.</span><span class="pln">withBinaryFile</span> <span class="pln">fp</span> <span class="typ">IO</span><span class="pun">.</span><span class="typ">ReadMode</span> <span class="pun">$</span> <span class="pun">\</span><span class="pln">handle</span> <span class="pun">-</span><span class="pun">&gt;</span>
       <span class="pln">withBody</span> <span class="pun">$</span> <span class="pun">\</span><span class="pln">sendChunk</span> <span class="pln">_flush</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="pln">fix</span> <span class="pun">$</span> <span class="pun">\</span><span class="pln">loop</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="kwd">do</span>
            <span class="pln">bs</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">hGetSome</span> <span class="pln">handle</span> <span class="pln">defaultChunkSize</span>
            <span class="kwd">unless</span> <span class="pun">(</span><span class="typ">B</span><span class="pun">.</span><span class="kwd">null</span> <span class="pln">bs</span><span class="pun">)</span> <span class="pun">$</span> <span class="kwd">do</span>
                <span class="pln">sendChunk</span> <span class="pun">$</span> <span class="pln">fromByteString</span> <span class="pln">bs</span>
                <span class="pln">loop</span>
    <span class="pun">)</span>
<span class="pln">responseToStream</span> <span class="pun">(</span><span class="typ">ResponseBuilder</span> <span class="pln">s</span> <span class="pln">h</span> <span class="pln">b</span><span class="pun">)</span> <span class="pun">=</span>
    <span class="pun">(</span><span class="pln">s</span><span class="pun">,</span> <span class="pln">h</span><span class="pun">,</span> <span class="pun">\</span><span class="pln">withBody</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="pln">withBody</span> <span class="pun">$</span> <span class="pun">\</span><span class="pln">sendChunk</span> <span class="pln">_flush</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="pln">sendChunk</span> <span class="pln">b</span><span class="pun">)</span>
<span class="pln">responseToStream</span> <span class="pun">(</span><span class="typ">ResponseRaw</span> <span class="pln">_</span> <span class="pln">res</span><span class="pun">)</span> <span class="pun">=</span> <span class="pln">responseToStream</span> <span class="pln">res</span>

<span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span><span class="pun">-</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">The</span> <span class="typ">WAI</span> <span class="pln">application</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Note</span> <span class="pln">that</span><span class="pun">,</span> <span class="pln">since</span> <span class="typ">WAI</span> <span class="dec">3.0</span><span class="pun">,</span> <span class="kwd">this</span> <span class="kwd">type</span> <span class="kwd">is</span> <span class="pln">structured</span> <span class="kwd">in</span> <span class="pln">continuation</span> <span class="pln">passing</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">style</span> <span class="pln">to</span> <span class="pln">allow</span> <span class="kwd">for</span> <span class="pln">proper</span> <span class="pln">safe</span> <span class="pln">resource</span> <span class="pln">handling</span><span class="pun">.</span> <span class="typ">This</span> <span class="pln">was</span> <span class="pln">handled</span> <span class="kwd">in</span> <span class="pln">the</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">past</span> <span class="pln">via</span> <span class="pln">other</span> <span class="pln">means</span> <span class="pun">(</span><span class="pln">e</span><span class="pun">.</span><span class="pln">g</span><span class="pun">.</span><span class="pun">,</span> <span class="pun">@</span><span class="typ">ResourceT</span><span class="pun">@</span><span class="pun">)</span><span class="pun">.</span> <span class="typ">As</span> <span class="pln">a</span> <span class="pln">demonstration</span><span class="pun">:</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">app</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Application</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">app</span> <span class="pln">req</span> <span class="pln">respond</span> <span class="pun">=</span> <span class="pln">bracket_</span>
<span class="pun">-</span><span class="pun">-</span>     <span class="pun">(</span><span class="pln">putStrLn</span> <span class="pun">\</span><span class="str">&#34;Allocating scarce resource\&#34;)
</span><span class="pun">-</span><span class="pun">-</span>     <span class="pun">(</span><span class="pln">putStrLn</span> <span class="pun">\</span><span class="str">&#34;Cleaning up\&#34;)
</span><span class="pun">-</span><span class="pun">-</span>     <span class="pun">(</span><span class="pln">respond</span> <span class="pun">$</span> <span class="pln">responseLBS</span> <span class="pln">status200</span> <span class="pun">[</span><span class="pun">]</span> <span class="pun">\</span><span class="str">&#34;Hello World\&#34;)
</span><span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span>
<span class="kwd">type</span> <span class="typ">Application</span> <span class="pun">=</span> <span class="typ">Request</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="pun">(</span><span class="typ">Response</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="typ">ResponseReceived</span><span class="pun">)</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="typ">ResponseReceived</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Middleware</span> <span class="kwd">is</span> <span class="pln">a</span> <span class="pln">component</span> <span class="pln">that</span> <span class="pln">sits</span> <span class="pln">between</span> <span class="pln">the</span> <span class="pln">server</span> <span class="kwd">and</span> <span class="pln">application</span><span class="pun">.</span> <span class="typ">It</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">can</span> <span class="kwd">do</span> <span class="pln">such</span> <span class="pln">tasks</span> <span class="kwd">as</span> <span class="typ">GZIP</span> <span class="pln">encoding</span> <span class="kwd">or</span> <span class="pln">response</span> <span class="pln">caching</span><span class="pun">.</span> <span class="typ">What</span> <span class="pln">follows</span> <span class="kwd">is</span> <span class="pln">the</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">general</span> <span class="pln">definition</span> <span class="pln">of</span> <span class="pln">middleware</span><span class="pun">,</span> <span class="pln">though</span> <span class="pln">a</span> <span class="pln">middleware</span> <span class="pln">author</span> <span class="pln">should</span> <span class="pln">feel</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">free</span> <span class="pln">to</span> <span class="pln">modify</span> <span class="kwd">this</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">As</span> <span class="pln">an</span> <span class="pln">example</span> <span class="pln">of</span> <span class="pln">an</span> <span class="pln">alternate</span> <span class="kwd">type</span> <span class="kwd">for</span> <span class="pln">middleware</span><span class="pun">,</span> <span class="pln">suppose</span> <span class="pln">you</span> <span class="pln">write</span> <span class="pln">a</span>
<span class="pun">-</span><span class="pun">-</span> <span class="kwd">function</span> <span class="pln">to</span> <span class="pln">load</span> <span class="pln">up</span> <span class="pln">session</span> <span class="pln">information</span><span class="pun">.</span> <span class="typ">The</span> <span class="pln">session</span> <span class="pln">information</span> <span class="kwd">is</span> <span class="pln">simply</span> <span class="pln">a</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">string</span> <span class="kwd">map</span> <span class="pun">\</span><span class="pun">[</span><span class="pun">(</span><span class="typ">String</span><span class="pun">,</span> <span class="typ">String</span><span class="pun">)</span><span class="pun">\</span><span class="pun">]</span><span class="pun">.</span> <span class="typ">A</span> <span class="pln">logical</span> <span class="kwd">type</span> <span class="pln">signature</span> <span class="kwd">for</span> <span class="kwd">this</span> <span class="pln">middleware</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">might</span> <span class="pln">be</span><span class="pun">:</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pun">@</span> <span class="pln">loadSession</span> <span class="pun">:</span><span class="pun">:</span> <span class="pun">(</span><span class="pun">[</span><span class="pun">(</span><span class="typ">String</span><span class="pun">,</span> <span class="typ">String</span><span class="pun">)</span><span class="pun">]</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Application</span><span class="pun">)</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Application</span> <span class="pun">@</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Here</span><span class="pun">,</span> <span class="pln">instead</span> <span class="pln">of</span> <span class="pln">taking</span> <span class="pln">a</span> <span class="pln">standard</span> <span class="str">&#39;Application&#39;</span> <span class="kwd">as</span> <span class="pln">its</span> <span class="pln">first</span> <span class="pln">argument</span><span class="pun">,</span> <span class="pln">the</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">middleware</span> <span class="pln">takes</span> <span class="pln">a</span> <span class="kwd">function</span> <span class="pln">which</span> <span class="pln">consumes</span> <span class="pln">the</span> <span class="pln">session</span> <span class="pln">information</span> <span class="kwd">as</span> <span class="pln">well</span><span class="pun">.</span>
<span class="kwd">type</span> <span class="typ">Middleware</span> <span class="pun">=</span> <span class="typ">Application</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">Application</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">A</span> <span class="kwd">default</span><span class="pun">,</span> <span class="pln">blank</span> <span class="pln">request</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Since</span> <span class="dec">2.0</span><span class="dec">.0</span>
<span class="pln">defaultRequest</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Request</span>
<span class="pln">defaultRequest</span> <span class="pun">=</span> <span class="typ">Request</span>
    <span class="pun">{</span> <span class="pln">requestMethod</span> <span class="pun">=</span> <span class="typ">H</span><span class="pun">.</span><span class="pln">methodGet</span>
    <span class="pun">,</span> <span class="pln">httpVersion</span> <span class="pun">=</span> <span class="typ">H</span><span class="pun">.</span><span class="pln">http10</span>
    <span class="pun">,</span> <span class="pln">rawPathInfo</span> <span class="pun">=</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">empty</span>
    <span class="pun">,</span> <span class="pln">rawQueryString</span> <span class="pun">=</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">empty</span>
    <span class="pun">,</span> <span class="pln">requestHeaders</span> <span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span>
    <span class="pun">,</span> <span class="pln">isSecure</span> <span class="pun">=</span> <span class="kwd">False</span>
    <span class="pun">,</span> <span class="pln">remoteHost</span> <span class="pun">=</span> <span class="typ">SockAddrInet</span> <span class="dec">0</span> <span class="dec">0</span>
    <span class="pun">,</span> <span class="pln">pathInfo</span> <span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span>
    <span class="pun">,</span> <span class="pln">queryString</span> <span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span>
    <span class="pun">,</span> <span class="pln">requestBody</span> <span class="pun">=</span> <span class="kwd">return</span> <span class="typ">B</span><span class="pun">.</span><span class="pln">empty</span>
    <span class="pun">,</span> <span class="pln">vault</span> <span class="pun">=</span> <span class="pln">mempty</span>
    <span class="pun">,</span> <span class="pln">requestBodyLength</span> <span class="pun">=</span> <span class="typ">KnownLength</span> <span class="dec">0</span>
    <span class="pun">,</span> <span class="pln">requestHeaderHost</span> <span class="pun">=</span> <span class="typ">Nothing</span>
    <span class="pun">,</span> <span class="pln">requestHeaderRange</span> <span class="pun">=</span> <span class="typ">Nothing</span>
    <span class="pun">}</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Get</span> <span class="pln">the</span> <span class="pln">request</span> <span class="pln">body</span> <span class="kwd">as</span> <span class="pln">a</span> <span class="pln">lazy</span> <span class="typ">ByteString</span><span class="pun">.</span> <span class="typ">However</span><span class="pun">,</span> <span class="kwd">do</span> <span class="pun">/</span><span class="kwd">not</span><span class="pun">/</span> <span class="kwd">use</span> <span class="pln">any</span> <span class="pln">lazy</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">I</span><span class="pun">\</span><span class="pun">/</span><span class="typ">O</span><span class="pun">,</span> <span class="pln">instead</span> <span class="pln">reading</span> <span class="pln">the</span> <span class="pln">entire</span> <span class="pln">body</span> <span class="pln">into</span> <span class="pln">memory</span> <span class="pln">strictly</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Since</span> <span class="dec">3.0</span><span class="dec">.1</span>
<span class="pln">strictRequestBody</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Request</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="typ">L</span><span class="pun">.</span><span class="typ">ByteString</span>
<span class="pln">strictRequestBody</span> <span class="pln">req</span> <span class="pun">=</span>
    <span class="pln">loop</span> <span class="pln">id</span>
  <span class="kwd">where</span>
    <span class="pln">loop</span> <span class="pln">front</span> <span class="pun">=</span> <span class="kwd">do</span>
        <span class="pln">bs</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="pln">requestBody</span> <span class="pln">req</span>
        <span class="kwd">if</span> <span class="typ">B</span><span class="pun">.</span><span class="kwd">null</span> <span class="pln">bs</span>
            <span class="kwd">then</span> <span class="kwd">return</span> <span class="pun">$</span> <span class="pln">front</span> <span class="typ">LI</span><span class="pun">.</span><span class="typ">Empty</span>
            <span class="kwd">else</span> <span class="pln">loop</span> <span class="pun">(</span><span class="pln">front</span> <span class="pun">.</span> <span class="typ">LI</span><span class="pun">.</span><span class="typ">Chunk</span> <span class="pln">bs</span><span class="pun">)</span>

<span class="pun">-</span><span class="pun">-</span> <span class="pun">|</span> <span class="typ">Get</span> <span class="pln">the</span> <span class="pln">request</span> <span class="pln">body</span> <span class="kwd">as</span> <span class="pln">a</span> <span class="pln">lazy</span> <span class="typ">ByteString</span><span class="pun">.</span> <span class="typ">This</span> <span class="pln">uses</span> <span class="pln">lazy</span> <span class="typ">I</span><span class="pun">\</span><span class="pun">/</span><span class="typ">O</span> <span class="pln">under</span> <span class="pln">the</span>
<span class="pun">-</span><span class="pun">-</span> <span class="pln">surface</span><span class="pun">,</span> <span class="kwd">and</span> <span class="pln">therefore</span> <span class="pln">all</span> <span class="pln">typical</span> <span class="pln">warnings</span> <span class="pln">regarding</span> <span class="pln">lazy</span> <span class="typ">I</span><span class="pun">/</span><span class="typ">O</span> <span class="pln">apply</span><span class="pun">.</span>
<span class="pun">-</span><span class="pun">-</span>
<span class="pun">-</span><span class="pun">-</span> <span class="typ">Since</span> <span class="dec">1.4</span><span class="dec">.1</span>
<span class="pln">lazyRequestBody</span> <span class="pun">:</span><span class="pun">:</span> <span class="typ">Request</span> <span class="pun">-</span><span class="pun">&gt;</span> <span class="typ">IO</span> <span class="typ">L</span><span class="pun">.</span><span class="typ">ByteString</span>
<span class="pln">lazyRequestBody</span> <span class="pln">req</span> <span class="pun">=</span>
    <span class="pln">loop</span>
  <span class="kwd">where</span>
    <span class="pln">loop</span> <span class="pun">=</span> <span class="pln">unsafeInterleaveIO</span> <span class="pun">$</span> <span class="kwd">do</span>
        <span class="pln">bs</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="pln">requestBody</span> <span class="pln">req</span>
        <span class="kwd">if</span> <span class="typ">B</span><span class="pun">.</span><span class="kwd">null</span> <span class="pln">bs</span>
            <span class="kwd">then</span> <span class="kwd">return</span> <span class="typ">LI</span><span class="pun">.</span><span class="typ">Empty</span>
            <span class="kwd">else</span> <span class="kwd">do</span>
                <span class="pln">bss</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="pln">loop</span>
                <span class="kwd">return</span> <span class="pun">$</span> <span class="typ">LI</span><span class="pun">.</span><span class="typ">Chunk</span> <span class="pln">bs</span> <span class="pln">bss</span>
</div>
      </div>
      
    </div>
  </body>
</html>
